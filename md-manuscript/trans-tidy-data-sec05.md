## 事例研究

以下の事例研究では、整然データと整然ツールが、操作、可視化、モデル化の間の移行を容易にし、結果としてデータ分析を容易にすることを示す。ある関数の出力を他の関数への入力として正しい形式に変換するためだけに存在しているコードを見ることは一切ない。これから、分析を行うためのRコードを示す。ここでは、コード・結果・説明をしっかりと結びつけた形で交互に示すようにした。このことによって、Rについてよく知らなくても、あるいは私が使った慣用的手法についてよく知らなくても、容易に理解できるように努めたつもりだ。

この事例研究では、個人を単位としたメキシコでの死亡率データを使用する。最終的な目標は、1日を範囲としたときに異常な時間的パターンが見られる死因を検出することにある。図1は、すべての死因について1時間当たりの死亡者数を示した時間的パターンである。このパターンから最も離れている疾患を検出することが目標である。

この事例研究の完全なデータセットには、2008年のメキシコにおける53万9530人の死亡に関する情報がある。そして、このデータセットには、死亡場所、死亡時間、死因、死亡者に関する人口統計的な情報など55個の変数が含まれている。表15は、このデータセットの小規模な標本を示している。この表は、死亡時刻に関する変数（`year`「年」・`month`「月」・`day`「日」・`hour`「時」）と死因に関する変数（`cod`）に焦点を合わせている。

|   yod|  mod|  dod|  hod| cod |
|-----:|----:|----:|----:|:----|
|  2008|    1|    1|    1| B20 |
|  2008|    1|    2|    4| I67 |
|  2008|    1|    3|    8| I50 |
|  2008|    1|    4|   12| I50 |
|  2008|    1|    5|   16| K70 |
|  2008|    1|    6|   18| I21 |
|  2008|    1|    7|   20| I21 |
|  2008|    1|    8|    —| K74 |
|  2008|    1|   10|    5| K74 |
|  2008|    1|   11|    9| I21 |
|  2008|    1|   12|   15| I25 |
|  2008|    1|   13|   20| R54 |
|  2008|    1|   15|    2| I61 |
|  2008|    1|   16|    7| I21 |
|  2008|    1|   17|   13| I21 |

表15：53万9530行×55列のもともとのデータセットから、16行×5列を取り出した標本。

異常な時間的パターンを見つけるという目標に到達するために、以下のことを行う。まず、整然である`count`関数を用い、`cod`（死因）ごとに`hod`（死亡の時間）ごとの死亡者数を数え上げる。

```
hod2 <- count(deaths, c("hod", "cod"))
```

次に、`subset`を使って、欠損値を取り除く（欠損値は欠損しているゆえに、本事例研究の目的に合致していない）。

```
hod2 <- subset(hod2, !is.na(hod))
```

このことにより、表16(a)が得られる。次に、疾患について分かりやすいラベルを準備するために、このデータセットを`codes`データセットと結びつける。結びつけるときには、`cod`（死因）の変数に基づいて結びつける。すると、表16(b)に示すように、新しい変数である`disease`（疾患）が付け加わる。

```
hod2 <- join(hod2, codes, by = "cod")
```

|  hod| cod |  freq|
|----:|:----|-----:|
|    8| B16 |     4|
|    8| E84 |     3|
|    8| I21 |  2205|
|    8| N18 |   315|
|    9| B16 |     7|
|    9| E84 |     1|
|    9| I21 |  2209|
|    9| N18 |   333|
|   10| B16 |    10|
|   10| E84 |     7|
|   10| I21 |  2434|
|   10| N18 |   343|
|   11| B16 |     6|
|   11| E84 |     3|
|   11| I21 |  2128|

| disease                     |
|:----------------------------|
| Acute hepatitis B           |
| Cystic fibrosis             |
| Acute myocardial infarction |
| Chronic renal failure       |
| Acute hepatitis B           |
| Cystic fibrosis             |
| Acute myocardial infarction |
| Chronic renal failure       |
| Acute hepatitis B           |
| Cystic fibrosis             |
| Acute myocardial infarction |
| Chronic renal failure       |
| Acute hepatitis B           |
| Cystic fibrosis             |
| Acute myocardial infarction |

|  prop|
|-----:|
|  0.04|
|  0.03|
|  0.05|
|  0.04|
|  0.07|
|  0.01|
|  0.05|
|  0.04|
|  0.10|
|  0.07|
|  0.05|
|  0.04|
|  0.06|
|  0.03|
|  0.05|


|  freq\_all|  prop\_all|
|----------:|----------:|
|      21915|       0.04|
|      21915|       0.04|
|      21915|       0.04|
|      21915|       0.04|
|      22401|       0.04|
|      22401|       0.04|
|      22401|       0.04|
|      22401|       0.04|
|      24321|       0.05|
|      24321|       0.05|
|      24321|       0.05|
|      24321|       0.05|
|      23843|       0.05|
|      23843|       0.05|
|      23843|       0.05|

表16：データフレームの`hod2`から取り出した4つの疾患と4つの時間についての標本


死因ごとの死亡総数の違いは、何桁にもわたる。心臓発作による死亡は4万6794人であるのに対し、雪崩による死者はわずか10人にすぎない。ここから、総数でなく、1時間あたりの死亡率を比較することが理にかなっていることが示唆される。これは、`cod`（死因）でデータセットを分割し、`transform()`を使い、1時間あたりの頻度をその死因の総死亡数で割ったものをもって、新たに`prop`（比率）の列を追加することで計算される。この新しい列は、表16(c)に示されている。

`ddply()`は、第1の引数 (`hod2`) を第2の引数（`cod`変数）で分割し、第3の引数 (`transform`) を分割された個々の部分に適用する。第4の引数 (`prop = freq / sum(freq)`) は、`transform()`にわたされる。

```
hod2 <- ddply(hod2, "cod", transform, prop = freq / sum(freq))
```

次に、1時間あたりの全体的な平均死亡率を計算し、元のデータセットに統合する。これにより表16(d)が得られる。`prop`（比率）と`prop_all`（全体的な比率）を比較することで、各疾患について全体の発生パターンと容易に比較することができる。

まず、1時間ごとの死亡者数を何とかしよう。`hod`で`hod2`を分割し、死因ごとに合計を計算する。

```
overall <- ddply(hod2, "hod", summarise, freq_all = sum(freq))
```

次に、1時間ごとの死者の全体の割合を計算する。

```
overall <- transform(overall, prop_all = freq_all / sum(freq_all))
```

最後に、全体のデータセットを個別のデータセットと結合し、2つのデータセットを比較しやすくする。

```
hod2 <- join(hod2, overall, by = "hod")
```

次に、各死因の時間的パターンと全体の時間的パターンとの間の距離を計算する。この距離を測定するやり方にはさまざまなものがあるが、単純平均二乗偏差が理解を助けるだろう。また、各死因について、標本の大きさおよびそれによる総死亡者数を記録する。考慮する疾患が十分に代表的であることを確実にするために、我々は50人（ほぼ1時間当たり2人）以上の死亡がある疾患のみを扱う。

```
devi <- ddply(hod2, "cod", summarise,
  n = sum(freq),
  dist = mean((prop - prop_all)^2))

devi <- subset(devi, n > 50)
```

この推定量の分散に関する特性は分からないが、図2(a)のように`n`（標本の大きさ）と`deviation`（偏差）を図示することで視覚的に探索できる。線形な目盛りでは、標本の大きさが増えるにつれて散らばりが小さくなること以外、図から分かることはほとんどない。しかし、両対数目盛りにした図2(b)では、明確なパターンが見いだせる。このパターンは、頑健な線形モデルから得られた最適の当てはめ直線を追加すると特に見やすくなる。

```
ggplot(data = devi, aes(x = n, y = dist) + geom_point()

last_plot() +
  scale_x_log10() +
  scale_y_log10() +
  geom_smooth(method = "rlm", se = F)
```

我々は、x軸に関して近いもの同士のうちでyの値が相対的に大きいような点に関心を持っている。死亡者数を統制したとき、こうした点は全体のパターンから最もかけ離れた疾患を表す。

こうした異常な点を見つけるために、頑健な線形モデルを当てはめ、残差を図示する（図3）。図では残差が1.5の辺りが何もない領域となっている。このため、いささか恣意的ではあるが、残差が1.5以上になる疾患を選び出すことにする。このことは、2段階で行われる。まず、`devi`（疾患ごとに1行）から適切な行を選択する。そして、元の要約データセット（疾患ごとに24行）から一致する時間経過の情報を見つけ出す。

```
devi$resid <- resid(rlm(log(dist) ~ log(n), data = devi))
unusual <- subset(devi, resid > 1.5)
hod_unusual <- match_df(hod2, unusual)
```

最後に、異常な死因ごとに時間経過を図示する（図4）。ここで、変動の性質の違いがあるため、疾患を2つの図に分けた。上の図は、死亡者数が350人を超える疾患を示す。これに対して、下の図は死亡者数が350人に満たない疾患を示している。死因は、殺人・溺死・交通関連の3つの主要なグループに分類される。殺人は、一般に夜間に見られる。溺死は午後に見られる。交通関連の死亡は、通勤時間帯に見られる。背景の薄い灰色の線は、すべての病気の時間的推移を示している。

```
ggplot(data = subset(hod_unusual, n > 350), aes(x = hod, y = prop)) +
  geom_line(aes(y = prop_all), data = overall, colour = "grey50") +
  geom_line() +
  facet_wrap(~ disease, ncol = 3)
```
